name: Update Signatories Badges

on:
  push:
    paths:
      - "SIGNATORIES.md"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  update-badges:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Count signatories (individuals + organizations)
        id: counts
        shell: bash
        run: |
          set -euo pipefail

          count_table_after_heading () {
            local heading="$1"

            # Extract the markdown table that appears after a given heading.
            # Then count data rows:
            # - rows starting with '|'
            # - excluding header separator row like |---|
            # - excluding the header row (we'll subtract 1)
            # - excluding "placeholder" rows where Name is empty: "| 2 |  |  |  |  | YYYY-MM-DD |"
            #
            # Assumptions:
            # - heading exists exactly as in SIGNATORIES.md
            # - the first table after the heading is the relevant one

            awk -v heading="$heading" '
              BEGIN { in_section=0; in_table=0; rowcount=0; }
              $0 ~ "^# " heading "$" || $0 ~ "^# #" heading "$" || $0 ~ "^# ### " heading "$" || $0 ~ "^# #### " heading "$" { in_section=1; next }
              in_section && $0 ~ "^\\|" { in_table=1 }
              in_section && in_table {
                # stop table when we hit a blank line that is not a table row
                if ($0 !~ "^\\|") { exit }
                # skip separator rows (---)
                if ($0 ~ "^\\|[[:space:]-|:]+\\|[[:space:]]*$") next
                # keep all table rows for now
                print
              }
            ' SIGNATORIES.md \
            | awk '
              BEGIN { n=0; }
              {
                # Skip the header row (first printed row)
                if (NR==1) next

                # Heuristic: treat as placeholder if the "Name" (3rd column) is empty after trimming.
                # Split by "|" and trim spaces.
                # Columns: 1 empty, 2 Signature#, 3 Name/Org, ...
                split($0, a, "|")
                name=a[3]
                gsub(/^[ \t]+|[ \t]+$/, "", name)

                if (name == "") next
                n++
              }
              END { print n; }
            '
          }

          INDIV=$(count_table_after_heading "ðŸ‘¤ Individual Signatories" || true)
          ORGS=$(count_table_after_heading "ðŸ¢ Organizational Signatories" || true)

          # If the headings include emojis but your file headings differ slightly, adjust the strings above.
          # Fallback: try without emoji (common if you later remove them).
          if [[ -z "${INDIV}" ]]; then INDIV=$(count_table_after_heading "Individual Signatories" || echo 0); fi
          if [[ -z "${ORGS}" ]]; then ORGS=$(count_table_after_heading "Organizational Signatories" || echo 0); fi

          INDIV=${INDIV:-0}
          ORGS=${ORGS:-0}
          TOTAL=$((INDIV + ORGS))

          echo "individuals=$INDIV" >> "$GITHUB_OUTPUT"
          echo "organizations=$ORGS" >> "$GITHUB_OUTPUT"
          echo "total=$TOTAL" >> "$GITHUB_OUTPUT"

      - name: Write badge JSON files
        run: |
          INDIV="${{ steps.counts.outputs.individuals }}"
          ORGS="${{ steps.counts.outputs.organizations }}"
          TOTAL="${{ steps.counts.outputs.total }}"

          cat > signatories-individuals.json <<EOF
          { "label": "Individuals", "message": "${INDIV}", "color": "blue" }
          EOF

          cat > signatories-organizations.json <<EOF
          { "label": "Organizations", "message": "${ORGS}", "color": "blue" }
          EOF

          cat > signatories-total.json <<EOF
          { "label": "Signatories", "message": "${TOTAL}", "color": "blue" }
          EOF

      - name: Commit badge updates
        uses: EndBug/add-and-commit@v9
        with:
          add: |
            signatories-individuals.json
            signatories-organizations.json
            signatories-total.json
          message: "chore: update signatories badges"
